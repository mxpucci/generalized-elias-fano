name: build-linux

# Trigger manually from the GitHub Actions tab. You can extend this
# section to run on pushes or pull requests if desired.
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Check out the repository at the current commit using a Node‑based action
      # outside of any custom container. This avoids the glibc mismatch errors seen
      # when using a CentOS 7 job‑level container with Node 20【693600283039977†L30-L38】.
      - uses: actions/checkout@v4

      # Build the project inside an Alpine container using Docker. Alpine uses musl libc,
      # which allows us to produce a fully static binary (-static) that runs on CentOS 7
      # without depending on its outdated glibc. We mount the workspace into the container,
      # install build tools via apk, and compile every target (including the test binaries)
      # without executing ctest.
      - name: Build inside Alpine container
        run: |
          docker run --rm -v "$PWD":/workspace -w /workspace alpine:latest sh -c "
            # Install build tools, git, and OpenMP runtime for parallel processing
            # Git is required for FetchContent dependencies such as sdsl-lite
            # libgomp provides OpenMP runtime library for GCC
            apk add --no-cache build-base cmake git libgomp && \
            mkdir -p build && cd build && \
            cmake .. -DCMAKE_BUILD_TYPE=Release \
                     -DGEF_TARGET_ARCH=skylake-avx512 \
                     -DGEF_STATIC_LINK=ON \
                     -DGEF_BUILD_BENCHMARKS=ON \
                     -DGEF_BUILD_TESTS=ON && \
            cmake --build . -- -j\$(nproc)
          "

      # Verify both benchmark variants were built successfully
      - name: Verify benchmark executables
        run: |
          ls -lh build/benchmarks/compression_benchmark
          ls -lh build/benchmarks/compression_benchmark_no_omp
          ls -lh build/benchmarks/single_thread_compression_throughput
          ls -lh build/benchmarks/single_thread_compression_throughput_simd
          echo "✓ All benchmark and single-thread executables built successfully"

      # Ensure CLI binaries from src/ and every test executable were generated
      - name: Verify CLI and test executables
        run: |
          echo "CLI binaries:"
          ls -lh build/src/ugef \
                 build/src/rle_gef \
                 build/src/bgef \
                 build/src/bgef_no_rle
          echo "Test binaries:"
          ls -lh build/tests/gef_test \
                 build/tests/get_elements_test \
                 build/tests/learned_gef_test \
                 build/tests/overhead_test \
                 build/tests/predictor_training_test \
                 build/tests/simple_test \
                 build/tests/split_point_strategy_comparison_test \
                 build/tests/split_point_strategy_dataset_test \
                 build/tests/split_point_strategy_test \
                 build/tests/test_sdsl_bitvector \
                 build/tests/test_sux_bitvector
          echo "✓ CLI and test executables are present"

      # Upload the entire build directory so artifacts include every generated
      # binary (benchmarks, helper tools, etc.). Keep the run scripts alongside
      # the build output for convenience. Use v4 of the upload-artifact action
      # because earlier versions are deprecated.
      - name: Upload benchmarks
        uses: actions/upload-artifact@v4
        with:
          name: gef-linux-benchmarks
          path: |
            build
            run_benchmarks.sh
            validate_benchmark_json.sh