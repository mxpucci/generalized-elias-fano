name: build-linux

# Trigger manually from the GitHub Actions tab. You can extend this
# section to run on pushes or pull requests if desired.
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Check out the repository at the current commit using a Node‑based action
      # outside of any custom container. This avoids the glibc mismatch errors seen
      # when using a CentOS 7 job‑level container with Node 20【693600283039977†L30-L38】.
      - uses: actions/checkout@v4

      # Build the project inside an Alpine container using Docker. Alpine uses musl libc,
      # which allows us to produce a fully static binary (-static) that runs on CentOS 7
      # without depending on its outdated glibc. We mount the workspace into the container,
      # install build tools via apk, and compile every target (including the test binaries)
      # without executing ctest.
      - name: Build inside Alpine container
        run: |
          docker run --rm -v "$PWD":/workspace -w /workspace alpine:latest sh -c "
            # Install build tools, git, and OpenMP runtime for parallel processing
            # Git is required for FetchContent dependencies such as sdsl-lite
            # libgomp provides OpenMP runtime library for GCC
            apk add --no-cache build-base cmake git libgomp && \
            mkdir -p build && cd build && \
            cmake .. -DCMAKE_BUILD_TYPE=Release \
                     -DGEF_TARGET_ARCH=skylake-avx512 \
                     -DGEF_STATIC_LINK=ON \
                     -DGEF_BUILD_BENCHMARKS=ON \
                     -DGEF_BUILD_TESTS=ON && \
            cmake --build . -- -j\$(nproc)
          "

      # Verify both benchmark variants were built successfully
      - name: Verify benchmark executables
        run: |
          ls -lh build/benchmarks/compression_benchmark
          ls -lh build/benchmarks/compression_benchmark_no_omp
          ls -lh build/benchmarks/single_thread_compression_throughput
          ls -lh build/benchmarks/single_thread_compression_throughput_simd
          echo "✓ All benchmark and single-thread executables built successfully"

      # Ensure CLI binaries from src/ and every tracked test executable were generated.
      # Test sources that are gitignored (e.g., learned_gef_test) will not be listed by
      # `git ls-files` and therefore are skipped automatically.
      - name: Verify CLI and test executables
        run: |
          set -euo pipefail
          echo "CLI binaries:"
          for bin in build/src/ugef \
                     build/src/rle_gef \
                     build/src/bgef \
                     build/src/bgef_no_rle
          do
            if [ -x "$bin" ]; then
              ls -lh "$bin"
            else
              echo "❌ Missing CLI binary: $bin"
              exit 1
            fi
          done

          echo "Test binaries (tracked sources only):"
          had_tests=0
          while IFS= read -r test_src; do
            had_tests=1
            test_name=$(basename "$test_src" .cpp)
            bin="build/tests/${test_name}"
            if [ -x "$bin" ]; then
              ls -lh "$bin"
            else
              echo "❌ Missing test binary: $bin (source: $test_src)"
              exit 1
            fi
          done < <(git ls-files 'tests/*.cpp')

          if [ "$had_tests" -eq 0 ]; then
            echo "❌ No tracked test sources were found (git ls-files returned empty)."
            exit 1
          fi

          echo "✓ CLI and tracked test executables are present"

      # Upload the entire build directory so artifacts include every generated
      # binary (benchmarks, helper tools, etc.). Keep the run scripts alongside
      # the build output for convenience. Use v4 of the upload-artifact action
      # because earlier versions are deprecated.
      - name: Upload benchmarks
        uses: actions/upload-artifact@v4
        with:
          name: gef-linux-benchmarks
          path: |
            build
            !build/**/_deps/**
            !build/**/CMakeFiles/**
            !build/**/*.cmake
            run_benchmarks.sh
            validate_benchmark_json.sh