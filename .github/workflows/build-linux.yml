name: build-linux

# Trigger manually from the GitHub Actions tab. You can extend this
# section to run on pushes or pull requests if desired.
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Check out the repository at the current commit using a Node‑based action
      # outside of any custom container. This avoids the glibc mismatch errors seen
      # when using a CentOS 7 job‑level container with Node 20【693600283039977†L30-L38】.
      - uses: actions/checkout@v4

      # Build the project inside an Alpine container using Docker. Alpine uses musl libc,
      # which allows us to produce a fully static binary (-static) that runs on CentOS 7
      # without depending on its outdated glibc. We mount the workspace into the container
      # and install build tools via apk. The compilation uses aggressive optimisation
      # flags and targets the user’s Xeon Gold 6140M CPU. The resulting binary is
      # statically linked (`-static`) so it should run on the CentOS VM regardless of
      # the glibc version.
      - name: Build benchmarks in Alpine container
        run: |
          docker run --rm -v "$PWD":/workspace -w /workspace alpine:latest sh -c "
            # Install build tools, git, and OpenMP runtime for parallel processing
            # Git is required for FetchContent dependencies such as sdsl-lite
            # libgomp provides OpenMP runtime library for GCC
            apk add --no-cache build-base cmake git libgomp && \
            mkdir -p build && cd build && \
            cmake .. -DCMAKE_BUILD_TYPE=Release \
                     -DGEF_TARGET_ARCH=skylake-avx512 \
                     -DGEF_STATIC_LINK=ON \
                     -DGEF_BUILD_BENCHMARKS=ON && \
            make compression_benchmark compression_benchmark_no_omp -j\$(nproc)
          "

      # Verify both benchmark variants were built successfully
      - name: Verify benchmark executables
        run: |
          ls -lh build/benchmarks/compression_benchmark
          ls -lh build/benchmarks/compression_benchmark_no_omp
          echo "✓ Both benchmark variants built successfully"

      # Upload the compiled benchmark executables as a workflow artifact.
      # Use v4 of the upload‑artifact action because earlier versions are
      # deprecated. The v4 action improves performance and ensures compatibility.
      # We upload both the OpenMP-enabled and OpenMP-disabled variants.
      - name: Upload benchmarks
        uses: actions/upload-artifact@v4
        with:
          name: gef-linux-benchmarks
          path: |
            build/benchmarks/compression_benchmark
            build/benchmarks/compression_benchmark_no_omp
            build/benchmarks/simple_benchmark
            run_benchmarks.sh
            validate_benchmark_json.sh