name: build-linux

# Trigger manually from the GitHub Actions tab. You can extend this
# section to run on pushes or pull requests if desired.
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Check out the repository at the current commit using a Node‑based action
      # outside of any custom container. This avoids the glibc mismatch errors seen
      # when using a CentOS 7 job‑level container with Node 20【693600283039977†L30-L38】.
      - uses: actions/checkout@v4

      # Build the project inside a CentOS 7 container using Docker. We mount the
      # workspace into the container and run all necessary installation and build
      # commands. This approach ensures the compiled binaries link against
      # glibc 2.17 and support the Xeon Gold 6140M while still allowing the
      # checkout and artifact actions to run on the host.
      - name: Build benchmarks in CentOS 7 container
        run: |
          docker run --rm -v "$PWD":/workspace -w /workspace centos:7 bash -c "
            yum install -y centos-release-scl epel-release && \
            yum install -y devtoolset-10 cmake3 git make && \
            source /opt/rh/devtoolset-10/enable && \
            mkdir -p build && cd build && \
            cmake3 .. -DCMAKE_BUILD_TYPE=Release \
                     -DCMAKE_CXX_FLAGS='-O3 -march=skylake-avx512 -mtune=skylake' \
                     -DGEF_BUILD_BENCHMARKS=ON && \
            make -j$(nproc)
          "

      # Upload the compiled benchmark executables as a workflow artifact.
      # Use v4 of the upload‑artifact action because earlier versions are
      # deprecated【693600283039977†L30-L38】.  The v4 action improves performance and
      # ensures compatibility going forward【349807780017072†L30-L48】.
      - name: Upload benchmarks
        uses: actions/upload-artifact@v4
        with:
          name: gef-linux-benchmarks
          path: build/benchmarks/*